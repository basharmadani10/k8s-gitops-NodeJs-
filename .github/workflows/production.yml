name: Production Deployment
on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  docker-production:
    name: Build & Push Docker Production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Set version
        run: echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV

      
      - name: Build Docker Image
        id: docker_build  
        run: |
          docker build -t bm106/k8s-gitops-nodejs:${{ env.VERSION }} -t bm106/k8s-gitops-nodejs:latest .

 
      - name: Scan Docker image with Trivy
        id: trivy_scan   
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: bm106/k8s-gitops-nodejs:${{ env.VERSION }}
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      
      - name: Push Docker Image
        id: docker_push  
        if: steps.trivy_scan.outcome == 'success' 
        run: |
          docker push bm106/k8s-gitops-nodejs:${{ env.VERSION }}
          docker push bm106/k8s-gitops-nodejs:latest

      
      - name: Create GitHub Release
        id: gh_release   
        if: steps.docker_push.outcome == 'success'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}

      
      - name: Slack Detailed Report
        if: always() 
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: "Deployment Status: ${{ job.status }}"
          SLACK_MESSAGE: |
            *Version:* ${{ env.VERSION }}
            
            *Step Breakdown:*
            üê≥ Build: ${{ steps.docker_build.outcome }}
            üõ°Ô∏è Security Scan: ${{ steps.trivy_scan.outcome }}
            üöÄ Push to Hub: ${{ steps.docker_push.outcome }}
            üì¶ GitHub Release: ${{ steps.gh_release.outcome }}
            
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Logs>